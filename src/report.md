## Содержание
- [Part 1. Инструмент ipcalc](#part-1-инструмент-ipcalc)
- [Part 2. Статическая маршрутизация между двумя машинами](#part-2-статическая-маршрутизация-между-двумя-машинами)
- [Part 3. Утилита iperf3](#part-3-утилита-iperf3)
- [Part 4. Сетевой экран](#part-4-сетевой-экран)
- [Part 5. Статическая маршрутизация сети](#part-5-статическая-маршрутизация-сети)
- [Part 6. Динамическая настройка IP с помощью DHCP](#part-6-динамическая-настройка-ip-с-помощью-dhcp)
- [Part 7. NAT](#part-7-nat)
- [Part 8. Дополнительно. Знакомство с SSH Tunnels](#part-8-дополнительно-знакомство-с-ssh-tunnels)

## Part 1. Инструмент ipcalc
### 1.1. Сети и маски
* После включения ВМ была установлена утилита ipcalc, выполнены следующие задания.

* ![network_address](screenshots/1.1%20Адрес%20сети.png)
* _**Рисунок 1.1 - Вывод адреса сети для 192.167.38.54/13**_

* ![prefix_binary_mask](screenshots/1.2%20Перевод%20в%20префиксную%20и%20двоичную%20запись%20255.255.255.0.png)
* _**Рисунок 1.2 Перевод соответственно в префиксную и двоичную запись маски 255.255.255.0**_

* ![ordinary_binary_mask](screenshots/1.3%20Перевод%20в%20обычную%20и%20двоичную%2015.png)
* _**Рисунок 1.3 - Перевод соответственно в обычную и двоичную запись маски /15**_

* Поскольку рассматриваемая утилита не принимает в качестве параметра маску в двоичной записи, для определения ее обычного вида сначала найдем ее префиксную запись. Это можно сделать вручную, посчитав количество единиц в заданной записи: 11111111.11111111.11111111.11110000. 

* 1 * 8 + 1 * 8 + 1 * 8 + 1 * 4 = 28. Это и есть искомый префикс. Далее найдем его обычную запись с помощью утилиты:

* ![ordinary_prefix_mask](screenshots/1.4%20Перевод%20в%20обычный%20вид%20из%20ранее%20заданного%20префикса.png)
* _**Рисунок 1.4 - Перевод в обычную запись из ранее определенного префикса маски 11111111.11111111.11111111.11110000**_

* ![minmax_host_prefix8](screenshots/1.5%20Минмакс%20хосты%20для%20маски%20префикса%208.png)
* _**Рисунок 1.5 - Минимальный и максимальный хосты для 12.167.38.4/8**_

* Для работы с двоичной маской 11111111.11111111.00000000.00000000 переведем ее в префикс: 1 * 8 + 1 * 8 = 16.

* ![minmax_host_binary](screenshots/1.6%20Минмакс%20хосты%20для%20двоичной%20маски.png)
* _**Рисунок 1.6 - Минимальный и максимальный хосты для 12.167.38.4 с маской 11111111.11111111.00000000.00000000**_

* ![minmax_host_ordinary](screenshots/1.7%20Минмакс%20хосты%20для%20обычной%20маски.png)
* _**Рисунок 1.7 - Минимальный и максимальный хосты для 12.167.38.4 с маской 255.255.254.0**_

* ![minmax_host_prefix4](screenshots/1.8%20Минмакс%20хосты%20для%20префикса%204.png)
* _**Рисунок 1.8 - Минимальный и максимальный хосты для 12.167.38.4/4**_

### 1.2. localhost
* Поскольку приложение работает на localhost, доступ к нему может осуществляться только внутри самого устройства, то есть с помощью loopback. По этой причине рассмотрим эту характеристику каждого предложенного адреса:

* ![localhost](screenshots/1.9%20Возможные%20адреса%20для%20доступа%20к%20localhost.png)
* _**Рисунок 1.9 - Возможные адреса для доступа к приложению на localhost**_

* Таким образом, только адреса, имеющие запись "loopback", могут обеспечивать доступ к приложению, работающему на localhost, а именно 127.0.0.2 и 127.1.0.1.

### 1.3. Диапазоны и сегменты сетей
* Далее приведен скриншот со всеми адресами, которые необходимо было проверить. Адреса для публиичного использования никак не помечаются, а адреса для частного использования имеют пометку "Private Internet".

* ![public_private_addresses](screenshots/1.10%20Адреса%20для%20публичного%20или%20частного%20использования.png)
* _**Рисунок 1.10 - Вывод класса адресов с пометкой/без пометки о частном использовании**_

* Таким образом, в качестве частных адресов можно использовать следующие: 10.0.0.45, 192.168.4.2, 172.20.250.4, 172.16.255.255 и 10.10.10.10, а остальные - в качестве публичных.

* Теперь определим возможные шлюзы для заданной сети:

* ![gateways](screenshots/1.11%20Определение%20возможных%20шлюзов.png)
* _**Рисунок 1.11 - Вывод информации о возможных шлюзах для сети 10.10.0.0/18**_

* Как видно из Рисунка 1.11, IP-адреса 10.10.0.2, 10.10.10.10 и 10.10.1.255 находятся в заданной сети, значит дальше будем рассматривать именно их. Чтобы эти адреса могли быть шлюзом, необходимо, чтобы они не были отведены под адрес самой сети или ее широковещательный адрес (Broadcast), а также не выходили на пределы диапазона (HostMin-HostMax), обозначенного в верхней части скриншота для адреса заданной сети. 

* Ни один из рассматриваемых IP-адресов не является сетевым/широковещательным для этой сети, также все эти адреса находятся в заданном диапазоне. Значит, у сети 10.10.0.0/18 возможны следующие IP-адреса шлюза: 10.10.0.2, 10.10.10.10 и 10.10.1.

## Part 2. Статическая маршрутизация между двумя машинами
* С помощью клонирования была поднята вторая ВМ - capricel-2 (все сетевые карты повторно инициализирваны). С помощью команды _ip a_ были просмотрены существующие сетевые интерфейсы на обеих машинах:

* ![interfaces_vm1](screenshots/2.1%20Сетевые%20интерфейсы%20ВМ1.png)
* _**Рисунок 2.1 - Существующие сетевые интерфейсы ВМ capricel-1**_

* Сетевой интерфейс, соответствующий внутренней сети для ВМ1- enp0s3 (активный) с IPv4-адресом 10.0.2.15/24, IPv6-адресом fd00::a00:27ff:fee9:76bd/64, MAC-адресом 08:00:27:e9:76:bd. Широковещательный (brd) IPv4-адрес - 10.0.2.255, максимальный размер одного пакета данных в байтах (mtu) - 1500.

* ![interfaces_vm2](screenshots/2.2%20Сетевые%20интерфейсы%20ВМ2.png)
* _**Рисунок 2.2 - Существующие сетевые интерфейсы ВМ capricel-2**_

* Сетевой интерфейс, соответствующий внутренней сети для ВМ2 - enp0s3 (активный) с IPv4-адресом 10.0.2.15/24, IPv6-адресом fd00::a00:27ff:fe50:7daf/64, MAC-адресом 08:00:27:50:7d:af. Широковещательный (brd) IPv4-адрес - 10.0.2.255, максимальный размер одного пакета данных в байтах (mtu) - 1500.

* Далее обеим машинам были заданы нужные IP-адреса и маски, для чего был изменен файл _/etc/netplan/00-installer-config.yaml_:

* ![netplan_file_vm1](screenshots/2.3%20Содержимое%20конф%20файла%20для%20ВМ1.png)
* _**Рисунок 2.3 - Содержимое файла на ВМ capricel-1**_

* ![netplan_file_vm2](screenshots/2.4%20Содержимое%20конф%20файла%20для%20ВМ2.png)
* _**Рисунок 2.4 - Содержимое файла на ВМ capricel-2**_

* Изначально конфигурационный файл имел не те права доступа, поэтому они были изменены с помощью команды _sudo chmod 600 etc/netplan/00-installer-config.yaml_.

* ![netplan_apply_vm1](screenshots/2.5%20netplan%20apply%20для%20ВМ1.png)
* _**Рисунок 2.5 - Применение команды _netplan apply_ для ВМ capricel-1**_

* ![netplan_apply_vm2](screenshots/2.6%20netplan%20apply%20для%20ВМ2.png)
* _**Рисунок 2.6 - Применение команды _netplan apply_ для ВМ capricel-2**_

* Из скриншотов видно, что изменения были успешно применены.

### 2.1. Добавление статического маршрута вручную
* С помощью команды _sudo ip route add 172.24.116.8 dev enp0s3_ для ВМ1 был добавлен маршрут до ВМ2, точно так же с помощью команды _sudo ip route add 192.168.100.10 dev enp0s3_ для ВМ2 добавлен маршрут до ВМ1:

* ![route_add_vm1](screenshots/2.7%20Добавление%20маршрута%20ВМ1.png)
* _**Рисунок 2.7 - Добавление статического маршрута для ВМ capricel-1**_

* ![route_add_vm2](screenshots/2.8%20Добавление%20маршрута%20ВМ2.png)
* _**Рисунок 2.8 - Добавление статического маршрута для ВМ capricel-2**_

* ![route_ping_vm1](screenshots/2.9%20Маршруты%20и%20пинг%20от%20ВМ1.png)
* _**Рисунок 2.9 - Маршруты ВМ capricel-1 и пинг до ВМ capricel-2**_

* ![route_ping_vm2](screenshots/2.10%20Маршруты%20и%20пинг%20от%20ВМ2.png)
* _**Рисунок 2.10 - Маршруты ВМ capricel-2 и пинг до ВМ capricel-1**_

### 2.2. Добавление статического маршрута с сохранением
* Для сохранения статического маршрута был изменен файл _etc/netplan/00-installer-config.yaml_ для обеих ВМ:

* ![config_save_vm1](screenshots/2.11%20Конфиг%20для%20ВМ1.png)
* _**Рисунок 2.11 - Измененный файл для ВМ capricel-1**_

* ![config_save_vm2](screenshots/2.12%20Конфиг%20для%20ВМ2.png)
* _**Рисунок 2.12 - Измененный файл для ВМ capricel-2**_

* ![route_save_vm1](screenshots/2.13%20netplan%20apply%20и%20маршруты%20для%20ВМ1.png)
* _**Рисунок 2.13 - Применение изменений и маршруты для ВМ capricel-1**_

* ![route_save_vm2](screenshots/2.14%20netplan%20apply%20и%20маршруты%20для%20ВМ2.png)
* _**Рисунок 2.14 - Применение изменений и маршруты для ВМ capricel-2**_

* ![ping_save_vm1](screenshots/2.15%20Пинг%20ВМ1.png)
* _**Рисунок 2.15 - Пинг ВМ capricel-1 до ВМ capricel-2**_

* ![ping_save_vm2](screenshots/2.16%20Пинг%20ВМ2.png)
* _**Рисунок 2.16 - Пинг ВМ capricel-2 до ВМ capricel-1**_

## Part 3. Утилита iperf3
### 3.1. Скорость соединения
* **8 Mbps** (мегабит в секунду) = 8 / 8 MB/s = _1 MB/s_ (мегабайт в секунду)

* **100 MB/s** (мегабайт в секунду) = 100 * 1024 KB/s = 102400 * 8 Kbps/s = _819200 Kbps/s_ (килобит в секунду)

* **1 Gbps** (гигабит в секунду) = 1 * 1024 Mbps/s = _1024 Mbps/s_ (мегабит в секунду)

### 3.2. Утилита iperf3
* Для измерения скорости соединения между ВМ и в качестве сервера возьмем capricel-1, а в качестве клиента - capricel-2:

* ![server_vm1](screenshots/3.1%20Скорость%20соединения%20через%20сервер.png)
* _**Рисунок 3.1 - Скорость соединения между ВМ на сервере**_

* ![client_vm2](screenshots/3.2%20Скорость%20соединения%20через%20клиент.png)
* _**Рисунок 3.2 - Скорость соединения между ВМ на клиенте**_

## Part 4. Сетевой экран
### 4.1. Утилита iptables
* ![firewall_script_vm1](screenshots/4.3%20Скрипт%20файервола%20для%20ВМ1.png)
* _**Рисунок 4.1 - Скрипт /etc/firewall.sh на ВМ capricel-1**_

* ![firewall_script_vm2](screenshots/4.4%20Скрипт%20файервола%20для%20ВМ2.png)
* _**Рисунок 4.2 - Скрипт /etc/firewall.sh на ВМ capricel-2**_

* После написания скриптов к ним была применена команда _sudo chmod +x_.

* ![start_script_vm1](screenshots/4.1%20Запуск%20скрипта%20на%20ВМ1.png)
* _**Рисунок 4.3 - Запуск /etc/firewall.sh на ВМ capricel-1 и пинг к capricel-2**_

* ![start_script_vm2](screenshots/4.2%20Запуск%20скрипта%20на%20ВМ2.png)
* _**Рисунок 4.4 - Запуск /etc/firewall.sh на ВМ capricel-2 и пинг к capricel-1**_

* Из скриншотов запуска видно, что пинг ВМ1 до ВМ2 проходит успешно, при этом пинг ВМ2 до ВМ1 не проходит. Это происходит по следующим причинам:

* Самым последним правилом в скрипте ВМ1 является разрешение echo reply для исходящих пакетов, но предпоследнее правило - на запрет. Пакеты проходят каждое правило в цепочке и принятие/сброс пакета зависят от того правила, которое встретится первым. Поскольку правило на сброс пакета встречается раньше, то выполняется в приоритетном порядке, так что ВМ2 не может получить ответ от ВМ1.

* На ВМ2 же наоборот, последнее правило - запрещающее, а предпоследнее - разрешающее. По аналогии, пакет принимается раньше, чем может быть отброшен, поэтому ВМ1 получает ответ от ВМ2.

### 4.2. Утилита nmap
* ![nmap_vm2](screenshots/4.5%20nmap.png)
* _**Рисунок 4.5 - Пинг capricel-2 до capricel-1 и данные команды nmap**_

* Из вывода команды _nmap_ видно, что хост ВМ1, к которой не проходит пинг, запущен.

## Part 5. Статическая маршрутизация сети
### 5.1. Настройка адресов машин
* Для удобства машины были переименованы, как на топологии. Для настройки r1 и r2 были включены дополнительные адаптеры (для интерфейсов eth1 - enp0s8). 

* ![netplan_r1](screenshots/5.1%20netplan-файл%20для%20r1.png)
* _**Рисунок 5.1 - Файл etc/netplan/00-installer-config.yaml для r1**_

* ![netplan_r2](screenshots/5.2%20netplan-файл%20для%20r2.png)
* _**Рисунок 5.2 - Файл etc/netplan/00-installer-config.yaml для r2**_

* ![netplan_ws11](screenshots/5.3%20netplan-файл%20для%20ws11.png)
* _**Рисунок 5.3 - Файл etc/netplan/00-installer-config.yaml для ws11**_

* ![netplan_ws22](screenshots/5.4%20netplan-файл%20для%20ws22.png)
* _**Рисунок 5.4 - Файл etc/netplan/00-installer-config.yaml для ws22**_

* ![netplan_ws21](screenshots/5.5%20netplan-файл%20для%20ws21.png)
* _**Рисунок 5.5 - Файл etc/netplan/00-installer-config.yaml для ws21**_

* Сервис сети был перезапущен с помощью команды _sudo systemctl restart systemd-networkd_.

* ![addresses_r1](screenshots/5.6%20Адреса%20и%20пинг%20r1.png)
* _**Рисунок 5.6 - Адреса r1 и пинг до ws11**_

* ![addresses_r2](screenshots/5.7%20Адреса%20r2.png)
* _**Рисунок 5.7 - Адреса r2**_

* ![addresses_ws11](screenshots/5.8%20Адреса%20ws11.png)
* _**Рисунок 5.8 - Адреса ws11**_

* ![addresses_ws22](screenshots/5.9%20Адреса%20и%20пинг%20ws22.png)
* _**Рисунок 5.9 - Адреса ws22 и пинг до ws21**_

* ![addresses_ws21](screenshots/5.10%20Адреса%20ws21.png)
* _**Рисунок 5.10 - Адреса ws21**_

### 5.2. Включение переадресации IP-адресов
* Команда *sysctl -w net.ipv4.ip_forward=1* включает IP-форвардинг для временной передачи данных - до следующей перезагрузки системы (на что указывает флаг -w). 

* IP-форвардинг - процесс передачи пакетов данных между сетями с помощью маршрутизаторов. По умолчанию в дистрибутивах Linux отключен.

* ![redirect_before_restart_r1](screenshots/5.11%20переадресация%20не%20рабочая%20после%20перезагрузки.png)
* _**Рисунок 5.11 - Включение переадресации пакетов до перезагрузки системы для r1**_

* ![redirect_before_restart_r2](screenshots/5.12%20переадресация%20не%20рабочая%20после%20перезагрузки%20r2.png)
* _**Рисунок 5.12 - Включение переадресации пакетов до перезагрузки системы для r2**_

* ![permanent_redirect_r1](screenshots/5.13%20постоянная%20переадресация%20для%20r1.png)
* _**Рисунок 5.13 - Включение постоянной переадресации пакетов для r1 через файл _/etc/sysctl.conf_**_

* ![permanent_redirect_r2](screenshots/5.14%20постоянная%20переадресация%20для%20r2.png)
* _**Рисунок 5.14 - Включение постоянной переадресации пакетов для r2 через файл _/etc/sysctl.conf_**_

### 5.3. Установка маршрута по умолчанию
* ![default_route_ws11](screenshots/5.15%20Файл%20netplan%20и%20default%20маршрут%20для%20ws11.png)
* _**Рисунок 5.15 - Измененный файл netplan и установка default маршрута для ws11**_

* ![default_route_ws22](screenshots/5.16%20Файл%20netplan%20и%20default%20маршрут%20для%20ws22.png)
* _**Рисунок 5.16 - Измененный файл netplan и установка default маршрута для ws22**_

* ![default_route_ws21](screenshots/5.17%20Файл%20netplan%20и%20default%20маршрут%20для%20ws21.png)
* _**Рисунок 5.17 - Измененный файл netplan и установка default маршрута для ws21**_

* Команда _tcpdump -tn -i eth0_, используемая далее, прослушивает сетевой интерфейс enp0s3, сообщает о захваченных пакетах.

* ![ping_ws11_to_r2](screenshots/5.20%20пинг%20от%20ws11%20до%20r2.png)
* _**Рисунок 5.18 - Проверка пинг от ws11 до r2 командой _sudo tcpdump -tn -i eth0_**_

### 5.4. Добавление статических маршрутов
* ![add_static_route_r1](screenshots/5.21%20Файл%20netplan%20и%20добавление%20статического%20маршрута%20r1.png)
* _**Рисунок 5.19 - Измененный файл netplan и добавление статического маршрута в таблицу маршрутизации для r1**_

* ![add_static_route_r2](screenshots/5.22%20Файл%20netplan%20и%20добавление%20статического%20маршрута%20r2.png)
* _**Рисунок 5.20 - Измененный файл netplan и добавление статического маршрута в таблицу маршрутизации для r2**_

* Команда _ip r list [адрес сети/маска]_ отображает записи таблицы маршрутизации для доступа к конкретному адресу. 

* ![chosen_routes_ws11](screenshots/5.23%20Выбранные%20маршруты%20с%20ws11.png)
* _**Рисунок 5.21 - Вывод команд _ip r list 10.10.0.0/18_ и _ip r list 0.0.0.0/0_ на ws11**_

* Для адреса 10.10.0.0/18 был выбран маршрут, отличный от того, который выбран для 0.0.0.0/0, потому что является конкретным адресом в сети с прописанным специфичным маршрутом, в то время как 0.0.0.0/0 представляет собой все адреса на локальном устройстве и не является маршрутизируемым. Специфичным маршрутам отдается большее предпочтение в таблице маршрутизации.

### 5.5. Построение списка маршрутизаторов
* ![dump_r1](screenshots/5.24%20Команда%20дампа%20на%20r1.png)
* _**Рисунок 5.22 - Вывод команды _sudo tcpdump -tnv -i eth0_ на r1**_

* ![traceroute_ws11_to_ws21](screenshots/5.25%20Команда%20traceroute%20от%20ws11%20до%20ws21.png)
* _**Рисунок 5.23 - Вывод команды _traceroute 10.20.0.10_ для построения пути от ws11 до ws21**_

* Принцип работы построения пути при помощи traceroute заключается в отправке пакетов до конечного адреса с учетом времени, которое потребовалось для достижения каждого маршрутизатора. Для вычисления используется время жизни TTL, которое уменьшается с каждым хопом, а также протокол UDP для передачи данных от исходного устройства до маршрутизатора без сообщений о получении пакетов. Для получения обратной связи исходным устройством используется протокол ICMP для отправки ответа от маршрутизатора до исходного устройства. traceroute анализирует ответы (адрес узла маршрута и время отклика) и составляет путь пакетов до адреса назначения. 

### 5.6. Использование протокола ICMP при маршрутизации
* ![dump_nonexist_r1](screenshots/5.26%20Дамп%20на%20r1.png)
* _**Рисунок 5.24 - Вывод команды _sudo tcpdump -n -i eth0 icmp_ на r1**_

* ![ping_nonexist_ws11](screenshots/5.27%20Пинг%20ws11%20на%20несуществующий%20адрес%20в%20сети.png)
* _**Рисунок 5.25 - Пинг с ws11 на несуществующий адрес**_

## Part 6. Динамическая настройка IP с помощью DHCP
* ![dhcp_conf_r2](screenshots/6.1%20dhcpd.conf%20для%20r2.png)
* _**Рисунок 6.1 - Содержимое файла _/etc/dhcp/dhcpd.conf_ для r2**_

* ![resolv_conf_r2](screenshots/6.2%20resolv.conf%20для%20r2.png)
* _**Рисунок 6.2 - Содержимое файла _/etc/resolv.conf_ для r2**_

* Изменения в файле _/etc/resolv.conf_ сбрасываются после перезагрузки системы.

* Перезагрузка dhcp производилась командой _sudo systemctl restart isc-dhcp-server_, машина ws21 перезапущена командой _reboot_.

* ![restart_r2](screenshots/6.0%20перезапуск%20для%20r2.png)
* _**Рисунок 6.3 - Перезапуск службы isc-dhcp-server на r2**_

* ![dhcp_address_ws21](screenshots/6.3%20Добавление%20динамического%20адреса%20на%20ws21.png)
* _**Рисунок 6.4 - Динамически полученный адрес для ws21, отображенный через команду _ip a_**_

* ![dhcp_address_ws21](screenshots/6.4%20Пинг%20ws22%20от%20ws21.png)
* _**Рисунок 6.5 - Успешный пинг от ws21 до ws22**_

* ![mac_address_ws11](screenshots/6.5%20Новый%20мак%20адрес%20для%20ws11.png)
* _**Рисунок 6.6 - Указание MAC-адреса для ws11 через изменение файла _/etc/netplan/00-installer-config.yaml_**_

* ![dhcp_conf_r1](screenshots/6.6%20Файл%20dhcpd%20для%20настройки%20r1.png)
* _**Рисунок 6.7 - Содержимое файла _/etc/dhcp/dhcpd.conf_ для r1**_

* ![resolv_conf_r1](screenshots/6.7%20Файл%20resolv%20для%20r1.png)
* _**Рисунок 6.8 - Содержимое файла _/etc/resolv.conf_ для r1**_

* ![restart_r1](screenshots/6.8%20перезапуск%20для%20r1.png)
* _**Рисунок 6.9 - Перезапуск службы isc-dhcp-server на r1**_

* ![address_hardware_ws11](screenshots/6.9%20Добавление%20динамического%20адреса%20на%20ws11.png)
* _**Рисунок 6.10 - Добавление динамического адреса с жесткой привязкой к MAC-адресу на ws11**_

* ![ping_ws11_to_ws22](screenshots/6.10%20Пинг%20от%20ws11%20до%20ws22.png)
* _**Рисунок 6.11 - Успешный пинг от ws11 до ws22**_

* ![before_refresh_ws21](screenshots/6.11%20ws21%20до%20обновления%20адреса.png)
* _**Рисунок 6.12 - ws21 до обновления адреса через dhcp**_

* ![after_refresh_ws21](screenshots/6.12%20ws21%20после%20обновления%20адреса.png)
* _**Рисунок 6.13 - ws21 после обновления адреса через dhcp**_

* Для обновления адреса использовалась команда _sudo dhclient -r_, освобождающая адреса не на конкретном интерфейсе, а на всех, но такой вариант освобождения адресов устарел (лучше прописывать интерфейс). 

* При использовании показанного варианта команды применяется DHCPRELEASE, представляющая собой сообщение об освобождении занимаемого IP-адреса для уведомления dhcp-сервера.

* В случае варианта _sudo dhclient -r enp0s3_ применяются следующие *опции*:
* **Option 1** - маска подсети, указанная в файле _/etc/dhcp/dhcpd.conf_;
* **Option 3** - основной шлюз, указанный в файле _/etc/dhcp/dhcpd.conf_ (option routers);
* **Option 6** - адрес DNS-сервера, указанный в файлах _/etc/dhcp/dhcpd.conf_ и _/etc/resolv.conf_;
* **Option 51** - время аренды IP-адреса. Явно не указано в файле _/etc/dhcp/dhcpd.conf_, но используется дефолтное значение (86400 секунд ~ 1 день).
* **Option 55** - список запрашиваемых опций для правильной конфигурации. Запрашиваются клиентом автоматически при обновлении IP-адреса.

## Part 7. NAT
* ![apache_conf_ws22_r1](screenshots/7.1%20Измененный%20файл%20на%20r1%20и%20ws22.png)
* _**Рисунок 7.1 - Измененный файл _/etc/apache2/ports_ на r1 и ws22**_

* ![apache_start_ws22](screenshots/7.2%20Запуск%20апача%20на%20ws22.png)
* _**Рисунок 7.2 - Запуск веб-сервера Apache на ws22**_

* ![apache_start_r1](screenshots/7.3%20Запуск%20апача%20на%20r1.png)
* _**Рисунок 7.3 - Запуск веб-сервера Apache на r1**_

* ![firewall_conf_r2](screenshots/7.4%20Добавление%20строк%20в%20файервол%20r2.png)
* _**Рисунок 7.4 - Изменение файервола на r2**_

* После изменения файла _/etc/firewall.sh_ были применены изменения запуском скрипта командами _sudo chmod +x /etc/firewall.sh_ и _sudo /etc/firewall.sh_.

* ![ping_refuse_ws22_to_r1](screenshots/7.5%20Неудачный%20пинг%20ws22%20до%20r1.png)
* _**Рисунок 7.5 - Неудачный пинг с ws22 на r1**_

* ![firewall_conf_r2_icmp](screenshots/7.6%20Добавление%20правила%20про%20icmp%20в%20файервол%20r2.png)
* _**Рисунок 7.6 - Изменение файервола на r2 с добавлением правила про icmp**_

* ![ping_success_ws22_to_r1](screenshots/7.7%20Успешный%20пинг%20ws22%20до%20r1.png)
* _**Рисунок 7.7 - Успешный пинг с ws22 на r1**_

* ![firewall_conf_r2_SNAT_DNAT](screenshots/7.8%20Добавление%20правил%20SNAT%20DNAT%20в%20файервол%20на%20r2.png)
* _**Рисунок 7.8 - Изменение файервола на r2 с добавлением правил SNAT и DNAT**_

* С помощью _--match state_ в скрипте файервола подключается модуль state, который в свою очередь позволяет разрешить входящие пакеты, являющиеся частью уже установленного соединения (_"ESTABLISHED,RELATED"_).

* ![check_snat_ws22_to_r1](screenshots/7.9%20Успешное%20подключение%20к%20серверу%20Apache%20с%20ws22%20на%20r1%20%20SNAT.png)
* _**Рисунок 7.9 - Успешное подключение с ws22 к веб-серверу Apahe на r1 с помощью команды _telnet 10.100.0.11 80_**_

* ![check_dnat_r1_to_ws22](screenshots/7.10%20Успешное%20подключение%20к%20серверу%20Apache%20с%20r1%20на%20ws22%20DNAT.png)
* _**Рисунок 7.10 - Успешное подключение с r1 к веб-серверу Apahe на ws22 с помощью команды _telnet 10.100.0.12 8080_**_

## Part 8. Дополнительно. Знакомство с SSH Tunnels
* Для того, чтобы веб-сервер работал только на локальном хосте, был изменен файл _/etc/apache2/ports.conf_ на r2 (с помощью _nano_), как показано на Рисунке 8.1 (прослушивание только через localhost:80).

* ![listen_localhost_ws22](screenshots/8.1%20Установка%20на%20ws22%20локального%20веб-сервера%20через%20изменение%20ports%20conf.png)
* _**Рисунок 8.1 - Изменение файла _/etc/apache2/ports_ на ws22 для запуска веб-сервера только на локальном хосте**_

* Для того, чтобы изменения вступили в силу, служба веб-сервера была перезапущена с помощью команды _sudo service apache2 restart_. Статус службы проверен командой _sudo service apache2 status_.

* ![restart_localhost_apache_ws22](screenshots/8.2%20Запуск%20веб-сервера%20на%20локальном%20хосте%20ws22%20после%20изменения%20файла.png)
* _**Рисунок 8.2 - Перезапуск службы apache2 и проверка статуса сервиса**_

* Локальная переадресация позволяет "связать" порты двух машин, чтобы обеспечить одной из них доступ к другой без публичного открытия порта. При этом запросы идут от машины-клиента к SSH-серверу, откуда перенаправляются машине-серверу.

* В нашем случае использовалась команда _ssh -L 8080:localhost:80 capricel@10.20.0.20_, флаг -L указывает на локальный тип переадресации, далее следует номер порта на локальной машине, с которого будет создаваться SSH-туннель, а затем адрес и порт удаленной машины, через которые можно получить доступ к нужному сервису. Следом указывается имя пользователя и адрес, к которым производится подключение.

* ![local_redirect_ws21_to_ws22](screenshots/8.3%20Локальная%20переадресация%20с%20ws21%20на%20веб-сервер%20ws22.png)
* _**Рисунок 8.3 - Локальная переадресация TCP с ws21 на ws22 для получения доступа к веб-серверу**_

* Для доступа к ws22 с ws11 не получится использовать локальную переадресацию, так как подсеть ws22 находится за настроенным NAT и получить к ней доступ извне нельзя. Для решения этой проблемы было осуществлено создание SSH-туннеля через удаленную переадресацию командой _ssh -R 8080:localhost:80 capricel@10.10.0.2_, запущенной на ws22 (обратный механизм). Здесь для обозначения удаленной переадресации используется уже флаг -R. Порты и адрес описаны так же, как для локальной переадресации, но различие в том, что в этот раз подключение производится с машины-сервера - она выступает в роли клиента, а машина-клиент - в роли сервера. Адрес хоста, к которому производится подключение (capricel@10.10.0.2) - это адрес машины ws11.

* ![remote_redirect_ws11_to_ws22](screenshots/8.4%20Удаленная%20переадресация%20с%20ws11%20на%20веб-сервер%20ws22.png)
* _**Рисунок 8.4 - Удаленная (обратная локальной) переадресация TCP с ws11 на ws22 для получения доступа к веб-серверу**_

* Далее была осуществлена проверка подключения путем установки соединения через telnet. Команды для проверки соединения при локальной и удаленной переадресации имеют вид _telnet 127.0.0.1 8080_, но запускаются с разных машин. 

* Локальная переадресация SSH проверяется на машине ws21, для открытия второго терминала той же ВМ были зажаты клавиши _Alt+F2_, для возвращения обратно к изначальному терминалу - _Alt+F1_.

* ![telnet_check_ws21](screenshots/8.5%20Успешное%20telnet%20подключение%20от%20ws21.png)
* _**Рисунок 8.5 - Успешное соединение с ws21 на веб-сервер ws22**_

* Удаленная переадресация SSH проверяется на машине ws11, поэтому открытие второго терминала для ws22 не требовалось.

* ![telnet_check_ws11](screenshots/8.6%20Успешное%20telnet%20подключение%20от%20ws11%20до%20ws22%20через%20ws11.png)
* _**Рисунок 8.6 - Успешное соединение с ws11 на веб-сервер ws22**_
